<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISP Kesinti Bildirim HaritasÄ± (TÃ¼rkiye)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <style>
        /* 1. Kurumsal TasarÄ±m ve Genel Stil */
        :root {
            --primary-color: #0056b3; /* Kurumsal Koyu Mavi */
            --danger-color: #c82333; /* Dikkat KÄ±rmÄ±zÄ±sÄ± */
            --text-color: #333333;
            --bg-color: #f8f9fa; /* AÃ§Ä±k Gri Arka Plan */

            /* KURUMSAL LÄ°DERLÄ°K RENKLERÄ° */
            --rank-1-bg: #1a4b7f; /* Koyu Lacivert/Gri */
            --rank-1-text: white;
            --rank-2-bg: #5a8cc1; /* Orta Mavi/AÃ§Ä±k Gri */
            --rank-2-text: white;
            --rank-3-bg: #a4c3e8; /* GÃ¶lge Mavi */
            --rank-3-text: black;
        }

        body {
            font-family: 'Tahoma', Arial, sans-serif;
            font-size: 14px; 
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* 2. Header ve Konteyner Stilleri */
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex; 
            align-items: center;
        }
        .header img {
            height: 50px; 
            width: 50px; 
            margin-right: 15px;
            border-radius: 50%;
            background-color: white; 
            padding: 5px;
            flex-shrink: 0;
        }
        .header h1 {
            margin: 0;
            font-size: 1.6rem; 
            flex-grow: 1; 
            text-align: center; 
        }
        .header .spacer { 
            width: 65px; 
            flex-shrink: 0;
        }

        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* 3. Ana Ä°Ã§erik DÃ¼zeni (Harita ve Ä°statistikler Yan Yana) */
        .main-content {
            display: flex;
            gap: 20px; /* BÃ¶lÃ¼mler arasÄ± boÅŸluk */
            margin-bottom: 20px;
        }
        
        #map {
            height: 500px; /* Harita yÃ¼ksekliÄŸi ayarlandÄ± */
            flex: 2; /* Ä°ki kat daha geniÅŸ olsun */
            min-width: 60%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .statistics-sidebar {
            flex: 1;
            min-width: 30%;
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }

        /* 4. Form AlanÄ± Stilleri (HaritanÄ±n AltÄ±nda Kalacak) */
        .info-box {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
        }
        .info-box h3 {
            color: var(--primary-color);
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-top: 0;
        }
        #location-status {
            font-size: 0.9em;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: bold;
        }


        /* 5. Form BileÅŸenleri Stilleri */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 10px; 
            box-sizing: border-box;
            border: 1px solid #ced4da;
            border-radius: 4px; 
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        .submit-btn {
            background-color: var(--danger-color); 
            color: white; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .submit-btn:hover {
            background-color: #a01a26;
        }
        /* CAPTCHA stili */
        #captcha-display {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: inline-block;
            margin-right: 10px;
        }

        /* 6. BaÅŸlÄ±k ve Liste Stilleri */
        #kesintiListesi {
            padding: 0;
            list-style: none;
        }
        #kesintiListesi li {
            background-color: #ffffff;
            margin-top: 8px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-left: 5px solid var(--danger-color); 
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            font-weight: 500;
        }
        .duration-highlight {
            font-weight: bold;
            color: var(--danger-color);
            margin-left: 10px;
        }
        h2, h3, h4 {
            color: var(--primary-color);
            font-weight: 600;
        }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.3rem; margin-top: 15px; } 
        h4 { font-size: 1.1rem; }


        /* 7. Lider Tablosu Stilleri */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .leaderboard-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }
        /* Ä°stenen deÄŸiÅŸiklik: Gri rengin AÃ§Ä±k Turkuaz yapÄ±lmasÄ± */
        .leaderboard-table tr:nth-child(even) {
            background-color: #e0f7fa; /* AÃ§Ä±k Turkuaz tonu */
        }
        
        /* KURUMSAL RENKLER */
        .rank-1 { background-color: var(--rank-1-bg); color: var(--rank-1-text); font-weight: bold;} 
        .rank-2 { background-color: var(--rank-2-bg); color: var(--rank-2-text); font-weight: bold;} 
        .rank-3 { background-color: var(--rank-3-bg); color: var(--rank-3-text); font-weight: 600;} 

        .monthly-board {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .monthly-board h4 {
            color: var(--danger-color);
            border-bottom: 2px solid var(--danger-color);
            padding-bottom: 5px;
            margin-top: 0;
        }
        
        /* Mobil uyumluluk (Ä°statistikler alt alta gelsin) */
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
            #map {
                height: 400px;
            }
            .statistics-sidebar {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjruzTuYNa5UBrIxZHHfWXMEYLE-8_98GDbXjDvK6MEn-kPBW1qcYXT-Emjr9hjXnCBLHRgcbKVQrIsMpNCZuKltYNFvX59ksVyihs7IjX-jWsY2LbpPYf015fR6hP0isYkarsoB0XoySYGJ569HlFgmZy_wtAiyQWFNm2e-WabFHbDP_roo3NtUqKtDBgf/s343/isp-down.png" alt="ISP Kesinti HaritasÄ± Logo">
        <h1>ISP Kesinti Bildirim HaritasÄ± (TÃœRKÄ°YE)</h1>
        <div class="spacer"></div>
    </div>

    <div class="container">
        <p>Arama Ã§ubuÄŸunu kullanarak konumu bulun veya haritada tÄ±klayÄ±n. Sistem, tÄ±kladÄ±ÄŸÄ±nÄ±z noktanÄ±n Ä°l ve Ä°lÃ§e bilgisini **otomatik** olarak bulacaktÄ±r.</p>
    </div>

    <div class="container main-content">
        <div id="map"></div>
        
        <div class="statistics-sidebar">
            <h2>ğŸ… Kesinti SÃ¼resi Lider TablolarÄ±</h2>
            
            <h3>Genel Ä°statistikler</h3>
            
            <h4>Internet Servis SaÄŸlayÄ±cÄ±larÄ± (ISP) Top 3</h4>
            <div id="ispLeaderboard">
                <p>Veriler hesaplanÄ±yor...</p>
            </div>

            <h4>BÃ¶lgeler (Ä°l / Ä°lÃ§e Top 5)</h4>
            <div id="locationLeaderboard">
                <p>Veriler hesaplanÄ±yor...</p>
            </div>
            
            <h3>ğŸ“… AylÄ±k ISP Kesinti Lider TablolarÄ± (Top 3)</h3>
            <div id="monthlyLeaderboards">
                <p>AylÄ±k veriler hesaplanÄ±yor...</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="info-box" id="infoBox">
            <p>Bildirim yapmak iÃ§in lÃ¼tfen haritada bir konuma **tÄ±klayÄ±n**.</p>
        </div>
        
        ---

        <h2>ğŸ”´ GeÃ§miÅŸ/Mevcut Bildirilen Kesintiler</h2>
        <ul id="kesintiListesi">
            <li>Åu anda gÃ¶rÃ¼ntÃ¼lenen bildirim bulunmamaktadÄ±r.</li>
        </ul>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    // =========================================================================
    // !!! GOOGLE FORM ENTEGRASYON BÃ–LÃœMÃœ - DEÄÄ°ÅMEZLER !!!
    // =========================================================================
    const GOOGLE_FORM_ACTION_URL = 'https://docs.google.com/forms/u/0/d/14QXuYohLt2tutZSh_330QdOQHAkg-kNx7NtXJXBXjQSGO0Q8/formResponse'; 

    const FORM_ENTRY_IDS = {
        iss: 'entry.1321343715',     
        il: 'entry.1048550212',     
        ilce: 'entry.1808925592',    
        lat: 'entry.119292663',     
        lng: 'entry.1923451466',
        kesintiTarihi: 'entry.888686904', 
        baslangicSaati: 'entry.1555945811',
        bitisSaati: 'entry.126525220'  
    };
    // =========================================================================

    // CAPTCHA iÃ§in global deÄŸiÅŸken
    let CAPTCHA_ANSWER = 0;
    
    // Uygulama Veri DepolarÄ± ve Harita DeÄŸiÅŸkenleri (Global)
    const kesintiler = []; 
    let tempMarker = null;
    let map; // Harita deÄŸiÅŸkeni global olarak tanÄ±mlanÄ±yor
    const markers = L.layerGroup(); // Marker gruplamasÄ± eklendi

    // =========================================================================
    // !!! YARDIMCI VE ENTEGRASYON FONKSÄ°YONLARI !!!
    // =========================================================================

    // Rastgele Matematik CAPTCHA'sÄ± oluÅŸturur
    function generateCaptcha() {
        const num1 = Math.floor(Math.random() * 10) + 1;
        const num2 = Math.floor(Math.random() * 10) + 1;
        
        CAPTCHA_ANSWER = num1 + num2;
        return `LÃ¼tfen bu iÅŸlemi Ã§Ã¶zÃ¼n: <span id="captcha-display">${num1} + ${num2} = ?</span>`;
    }

    // YYYY-MM-DD formatÄ±nda tarih dÃ¶ndÃ¼rÃ¼r
    function formatDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }
    
    // Tarih alanÄ±nÄ± kÄ±sÄ±tlar
    function restrictDateInput() {
        const today = new Date();
        const maxDate = formatDate(today);

        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(today.getMonth() - 6); 
        const minDate = formatDate(sixMonthsAgo);

        const dateInput = document.getElementById('kesintiTarihi');
        if (dateInput) {
            dateInput.setAttribute('max', maxDate);
            dateInput.setAttribute('min', minDate);
        }
    }
    
    // YardÄ±mcÄ± Fonksiyon: Dakika SÃ¼resini Saat/Dakika formatÄ±na Ã§evirir
    function formatMinutesToDuration(totalMinutes) {
        if (totalMinutes === 0) return "0 Dakika";

        const totalHours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        let formattedTime = "";

        if (totalHours > 0) formattedTime += `${totalHours} Saat `;
        if (minutes > 0) formattedTime += `${minutes} Dakika`;
        
        return formattedTime.trim();
    }

    // Kesinti SÃ¼resini Dakika Cinsinden Hesaplar
    function getDurationInMinutes(kesinti) {
        const dateStr = kesinti.kesintiTarihiRaw;
        const start = kesinti.baslangicSaati;
        const end = kesinti.bitisSaati;

        if (!dateStr || !start || !end) return 0;

        const startDateTimeStr = `${dateStr}T${start}:00`;
        const endDateTimeStr = `${dateStr}T${end}:00`;

        let startDate = new Date(startDateTimeStr);
        let endDate = new Date(endDateTimeStr);

        if (endDate.getTime() < startDate.getTime()) {
            endDate.setDate(endDate.getDate() + 1);
        }
        
        const diffMs = endDate.getTime() - startDate.getTime();
        return Math.floor(diffMs / (1000 * 60)); 
    }

    // Kesinti SÃ¼resini Hesaplayan Fonksiyon (GÃ¶rÃ¼ntÃ¼leme iÃ§in)
    function calculateDuration(dateStr, start, end) {
        const diffMinutes = getDurationInMinutes({ kesintiTarihiRaw: dateStr, baslangicSaati: start, bitisSaati: end });

        if (diffMinutes <= 0) return "Ã‡ok KÄ±sa SÃ¼reli / Belirtilmedi";
        
        return formatMinutesToDuration(diffMinutes);
    }

    // Genel ISP Lider Tablosunu gÃ¼nceller 
    function updateIspLeaderboard() {
        const ispTotals = {}; 

        kesintiler.forEach(k => {
            const durationMinutes = getDurationInMinutes(k);
            const isp = k.iss;

            if (!ispTotals[isp]) {
                ispTotals[isp] = 0;
            }
            ispTotals[isp] += durationMinutes;
        });

        const top3Isp = Object.keys(ispTotals)
            .map(isp => ({
                isp: isp,
                total: ispTotals[isp]
            }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 3);
        
        const container = document.getElementById('ispLeaderboard');
        
        if (top3Isp.length === 0) {
            container.innerHTML = '<p>HenÃ¼z yeterli kesinti bildirimi yapÄ±lmadÄ±ÄŸÄ± iÃ§in ISP lider tablosu boÅŸ.</p>';
            return;
        }
        
        let tableHtml = `<table class="leaderboard-table"><thead><tr><th>SÄ±ra</th><th>Internet Servis SaÄŸlayÄ±cÄ±sÄ± (ISP)</th><th>Toplam Kesinti SÃ¼resi</th></tr></thead><tbody>`;

        top3Isp.forEach((item, index) => {
            const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
            const formattedTime = formatMinutesToDuration(item.total);

            tableHtml += `<tr class="${rankClass}"><td>#${index + 1}</td><td>${item.isp}</td><td>${formattedTime}</td></tr>`;
        });
        
        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
    }

    // Ä°l/Ä°lÃ§e'ye gÃ¶re Top 5'i hesaplar ve gÃ¼nceller
    function updateLocationLeaderboard() {
        const locationTotals = {}; 

        kesintiler.forEach(k => {
            const locationKey = `${k.il} - ${k.ilce}`; 
            const durationMinutes = getDurationInMinutes(k);

            if (!locationTotals[locationKey]) {
                locationTotals[locationKey] = 0;
            }
            locationTotals[locationKey] += durationMinutes;
        });

        const top5Locations = Object.keys(locationTotals)
            .map(location => ({
                location: location,
                total: locationTotals[location]
            }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 5);
        
        const container = document.getElementById('locationLeaderboard');
        
        if (top5Locations.length === 0) {
            container.innerHTML = '<p>HenÃ¼z yeterli bÃ¶lge bildirimi yapÄ±lmadÄ±ÄŸÄ± iÃ§in lider tablosu boÅŸ.</p>';
            return;
        }
        
        let tableHtml = `<table class="leaderboard-table"><thead><tr><th>SÄ±ra</th><th>Ä°l / Ä°lÃ§e</th><th>Toplam Kesinti SÃ¼resi</th></tr></thead><tbody>`;

        top5Locations.forEach((item, index) => {
            const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
            const formattedTime = formatMinutesToDuration(item.total);

            tableHtml += `<tr class="${rankClass}"><td>#${index + 1}</td><td>${item.location}</td><td>${formattedTime}</td></tr>`;
        });
        
        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
    }

    // AylÄ±k ISP Lider Tablosunu Hesaplar ve YaratÄ±r
    function updateMonthlyIspLeaderboard() {
        const monthlyData = {}; 
            
        const monthNames = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", 
                             "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];

        kesintiler.forEach(k => {
            const monthKey = k.kesintiTarihiRaw.substring(0, 7); 
            const durationMinutes = getDurationInMinutes(k);
            const isp = k.iss;

            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = {};
            }
            if (!monthlyData[monthKey][isp]) {
                monthlyData[monthKey][isp] = 0;
            }
            monthlyData[monthKey][isp] += durationMinutes;
        });

        const container = document.getElementById('monthlyLeaderboards');
        if (Object.keys(monthlyData).length === 0) {
            container.innerHTML = '<p>HenÃ¼z aylÄ±k raporlama iÃ§in yeterli kesinti bildirimi yapÄ±lmamÄ±ÅŸtÄ±r.</p>';
            return;
        }

        const sortedMonths = Object.keys(monthlyData).sort().reverse();
        
        let finalHtml = '';

        sortedMonths.forEach(monthKey => {
            const [year, monthIndex] = monthKey.split('-');
            const monthName = monthNames[parseInt(monthIndex) - 1] || monthKey;

            const ispTotals = monthlyData[monthKey];
            const top3Isp = Object.keys(ispTotals)
                .map(isp => ({
                    isp: isp,
                    total: ispTotals[isp]
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 3);
            
            let monthlyTableHtml = `
                <div class="monthly-board">
                    <h4>${monthName} ${year} Top 3 ISP Kesinti SÃ¼resi</h4>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>SÄ±ra</th>
                                <th>ISP</th>
                                <th>Toplam SÃ¼re</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            top3Isp.forEach((item, index) => {
                const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                const formattedTime = formatMinutesToDuration(item.total);
                
                monthlyTableHtml += `
                        <tr class="${rankClass}">
                            <td>#${index + 1}</td>
                            <td>${item.isp}</td>
                            <td>${formattedTime}</td>
                        </tr>
                `;
            });

            monthlyTableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            finalHtml += monthlyTableHtml;
        });

        container.innerHTML = finalHtml;
    }
    
    // GeÃ§miÅŸ kesintileri listeye ekler
    function updateKesintiListesi() {
        const listElement = document.getElementById('kesintiListesi');
        if (!listElement) return;

        if (kesintiler.length === 0) {
            listElement.innerHTML = '<li>Åu anda gÃ¶rÃ¼ntÃ¼lenen bildirim bulunmamaktadÄ±r.</li>';
            return;
        }

        const listHtml = kesintiler.map(k => `
            <li>
                **${k.il} / ${k.ilce}** konumunda **${k.iss}** iÃ§in kesinti bildirimi.
                Tarih: ${k.tarih} | Saat: ${k.baslangicSaati} - ${k.bitisSaati}
                SÃ¼re: <span class="duration-highlight">${k.suresi}</span>
                <span style="font-size: 0.8em; color: #666; display: block;">Bildirim ZamanÄ±: ${k.bildirimZamani}</span>
            </li>
        `).join('');

        listElement.innerHTML = listHtml;
    }
    
    // Ters CoÄŸrafi Kodlama (Nominatim API)
    async function getLocationFromCoords(lat, lng) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data.address) {
                const address = data.address;
                
                let il = address.state || address.province || address.city;
                let ilce = address.city || address.town || address.village || address.suburb || address.district;

                if (il === ilce) {
                    ilce = address.suburb || address.district || "Bilinmiyor";
                }
                
                if (address.country_code === 'tr' && address.city && address.state) {
                    il = address.state;
                    ilce = address.city;
                }

                il = il || "Bilinmiyor";
                ilce = ilce || "Bilinmiyor";

                return { il, ilce };
            }
        } catch (error) {
            console.error("CoÄŸrafi kodlama hatasÄ±:", error);
        }
        return { il: "Bilinmiyor", ilce: "Bilinmiyor" };
    }

    // Bildirim Formunu OluÅŸturan Fonksiyon (Ä°l/Ä°lÃ§e bilgisi readonly olarak ekleniyor)
    function getFormHTML(lat, lng, il, ilce) {
        const captchaQuestion = generateCaptcha(); 
        // HTML'e yerleÅŸtirilecek string'leri sanitize etme
        const sanitizedIl = il.replace(/'/g, "\\'"); 
        const sanitizedIlce = ilce.replace(/'/g, "\\'"); 

        // Form gÃ¶nderimini addKesinti fonksiyonuna baÄŸlar
        return `
            <h3>âš ï¸ Yeni Kesinti Bildirimi GiriÅŸi</h3>
            <p>Konum: **Enlem: ${lat}, Boylam: ${lng}**</p>
            <p id="location-status">ğŸ“ Otomatik Konum: **${il} / ${ilce}**</p>
            
            <form onsubmit="addKesinti(event, '${lat}', '${lng}', '${sanitizedIl}', '${sanitizedIlce}')">
                
                <div class="form-group">
                    <label for="iss">Internet Servis SaÄŸlayÄ±cÄ±nÄ±z (ISP):</label>
                    <select id="iss" required>
                        <option value="">LÃ¼tfen SeÃ§iniz</option>
                        <option value="TurkNet">TurkNet</option>
                        <option value="TÃ¼rksat Kablonet">TÃ¼rksat Kablonet</option>
                        <option value="Turkcell Superonline">Turkcell Superonline</option>
                        <option value="Vodafone Net">Vodafone Net</option>
                        <option value="TÃ¼rk Telekom - TTNET">TÃ¼rk Telekom - TTNET</option>
                        <option value="Millenicom">Millenicom</option>
                        <option value="D-Smart Net">D-Smart Net</option>
                        <option value="Digiturk Ä°nternet">Digiturk Ä°nternet</option>
                        <option value="DiÄŸer">DiÄŸer / Bilmiyorum</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="kesintiTarihi">Kesintinin GerÃ§ekleÅŸtiÄŸi **Tarih** (Son 6 Ay Ä°Ã§inde):</label>
                    <input type="date" id="kesintiTarihi" required>
                </div>
                <div class="form-group">
                    <label for="baslangicSaati">Kesinti **BaÅŸlangÄ±Ã§** Saati:</label>
                    <input type="time" id="baslangicSaati" required>
                </div>
                <div class="form-group">
                    <label for="bitisSaati">Kesinti **BitiÅŸ** Saati:</label>
                    <input type="time" id="bitisSaati" required>
                </div>
                
                <div class="form-group">
                    <label for="captcha">Robot KontrolÃ¼:</label>
                    ${captchaQuestion}
                    <input type="number" id="captcha" placeholder="CevabÄ±nÄ±z" required style="width: 50%; display: inline-block;">
                </div>

                <button type="submit" class="submit-btn">ğŸ”´ Kesintiyi Haritaya Ekle</button>
            </form>
        `;
    }

    // Haritaya KalÄ±cÄ± Ä°ÅŸaretÃ§i Ekleyen Fonksiyon
    function addMarkerToMap(kesinti) {
        const marker = L.marker([kesinti.lat, kesinti.lng], {
            icon: L.divIcon({
                className: 'kesinti-marker',
                html: '<div style="background-color: var(--danger-color); width: 10px; height: 10px; border-radius: 50%; border: 2px solid white;"></div>',
                iconSize: [16, 16]
            })
        }).addTo(map);

        marker.bindPopup(`
            <b>Kesinti Bildirimi (${kesinti.iss})</b><br>
            <b>Konum:</b> ${kesinti.il} / ${kesinti.ilce}<br>
            <b>SÃ¼re:</b> ${kesinti.suresi}<br>
            <b>Tarih:</b> ${kesinti.tarih} ${kesinti.baslangicSaati}-${kesinti.bitisSaati}
        `);
        markers.addLayer(marker);
    }

    // =========================================================================
    // !!! GOOGLE FORM VERÄ° GÃ–NDERME FONKSÄ°YONU !!!
    // =========================================================================
    async function sendDataToGoogleForm(data) {
        const formData = new FormData();
        
        // Tarih ve saat parÃ§alama (Google Form iÃ§in Ã¶zel format)
        const [year, month, day] = data.kesintiTarihiRaw.split('-');
        const [startHour, startMinute] = data.baslangicSaati.split(':');
        const [endHour, endMinute] = data.bitisSaati.split(':');

        // Form Verilerini EÅŸleÅŸtirme (ID'ler kullanÄ±lÄ±yor)
        formData.append(FORM_ENTRY_IDS.iss, data.iss);
        formData.append(FORM_ENTRY_IDS.il, data.il);
        formData.append(FORM_ENTRY_IDS.ilce, data.ilce);
        formData.append(FORM_ENTRY_IDS.lat, data.lat);
        formData.append(FORM_ENTRY_IDS.lng, data.lng);

        // Tarih AlanÄ± (YÄ±l, Ay, GÃ¼n olarak parÃ§alanmÄ±ÅŸ)
        formData.append(`${FORM_ENTRY_IDS.kesintiTarihi}_year`, year);
        formData.append(`${FORM_ENTRY_IDS.kesintiTarihi}_month`, month);
        formData.append(`${FORM_ENTRY_IDS.kesintiTarihi}_day`, day);

        // BaÅŸlangÄ±Ã§ Saati AlanÄ± (Saat ve Dakika olarak parÃ§alanmÄ±ÅŸ)
        formData.append(`${FORM_ENTRY_IDS.baslangicSaati}_hour`, startHour);
        formData.append(`${FORM_ENTRY_IDS.baslangicSaati}_minute`, startMinute);

        // BitiÅŸ Saati AlanÄ± (Saat ve Dakika olarak parÃ§alanmÄ±ÅŸ)
        formData.append(`${FORM_ENTRY_IDS.bitisSaati}_hour`, endHour);
        formData.append(`${FORM_ENTRY_IDS.bitisSaati}_minute`, endMinute);

        try {
            // Google Form'a POST isteÄŸi
            const response = await fetch(GOOGLE_FORM_ACTION_URL, {
                method: 'POST',
                body: formData,
                mode: 'no-cors' // Form gÃ¶nderimi iÃ§in 'no-cors' kullanÄ±lÄ±r
            });

            console.log('Veri Google Formâ€™a baÅŸarÄ±yla gÃ¶nderildi (no-cors modu).');
        } catch (error) {
            console.error('Google Formâ€™a veri gÃ¶nderilirken hata oluÅŸtu:', error);
        }
    }


    // =========================================================================
    // !!! ANA KESÄ°NTÄ° EKLEME FONKSÄ°YONU (GÃœNCELLENMÄ°Å) !!!
    // =========================================================================
    function addKesinti(event, lat, lng, il, ilce) {
        event.preventDefault(); 

        // GÃœVENLÄ°K KONTROLÃœ: CAPTCHA
        const captchaInput = document.getElementById('captcha').value;
        if (parseInt(captchaInput) !== CAPTCHA_ANSWER) { 
            alert("Robot kontrolÃ¼ baÅŸarÄ±sÄ±z oldu. LÃ¼tfen iÅŸlemi doÄŸru Ã§Ã¶zdÃ¼ÄŸÃ¼nÃ¼zden emin olun.");
            // Formu yeniden oluÅŸtur
            document.getElementById('infoBox').innerHTML = getFormHTML(lat, lng, il, ilce); 
            restrictDateInput(); 
            return;
        }
        
        const isp = document.getElementById('iss').value; 
        const kesintiTarihi = document.getElementById('kesintiTarihi').value; 
        const baslangicSaati = document.getElementById('baslangicSaati').value;
        const bitisSaati = document.getElementById('bitisSaati').value;
        const now = new Date().toLocaleTimeString('tr-TR');
        
        // Tarih kontrolÃ¼
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(new Date().getMonth() - 6); 
        const selectedDate = new Date(kesintiTarihi);
        
        if (selectedDate > new Date() || selectedDate < sixMonthsAgo) {
            alert("LÃ¼tfen kesinti tarihini bugÃ¼nden ve son 6 ay iÃ§erisinden seÃ§iniz.");
            return;
        }

        const kesintiSuresi = calculateDuration(kesintiTarihi, baslangicSaati, bitisSaati); 
        if (getDurationInMinutes({ kesintiTarihiRaw: kesintiTarihi, baslangicSaati: baslangicSaati, bitisSaati: bitisSaati }) <= 0) {
             alert("Kesinti bitiÅŸ saati, baÅŸlangÄ±Ã§ saatinden sonra olmalÄ±dÄ±r. (GÃ¼n aÅŸÄ±mÄ± otomatik hesaplanÄ±r, bu nedenle sadece baÅŸlangÄ±Ã§tan sonra bir zaman girmeniz yeterlidir.)");
             return;
        }


        const [year, month, day] = kesintiTarihi.split('-');
        const formattedDate = `${day}.${month}.${year.substring(2)}`; 

        const yeniKesinti = {
            id: Date.now(),
            lat: parseFloat(lat),
            lng: parseFloat(lng),
            iss: isp, 
            il: il, 
            ilce: ilce, 
            tarih: formattedDate, 
            kesintiTarihiRaw: kesintiTarihi, 
            baslangicSaati: baslangicSaati,
            bitisSaati: bitisSaati,
            suresi: kesintiSuresi,
            bildirimZamani: now,
        };
        
        // KRÄ°TÄ°K ADIM: Veriyi Google Form'a gÃ¶nder
        sendDataToGoogleForm(yeniKesinti); 

        // Harita/Liste/Lider TablolarÄ±nÄ± gÃ¼ncelleme
        kesintiler.push(yeniKesinti);
        
        if (tempMarker) {
            map.removeLayer(tempMarker);
            tempMarker = null;
        }
        addMarkerToMap(yeniKesinti);
        updateKesintiListesi();
        updateIspLeaderboard();
        updateLocationLeaderboard(); 
        updateMonthlyIspLeaderboard(); 

        document.getElementById('infoBox').innerHTML = `<p>âœ… **${il} / ${ilce}** konumundan **${isp}** iÃ§in bildiriminiz **alÄ±ndÄ± ve Google Sheets'e gÃ¶nderildi.** Kesinti sÃ¼resi: <span class="duration-highlight">${kesintiSuresi}</span></p>`;
    }


    // =========================================================================
    // !!! HARÄ°TA BAÅLATMA VE OLAY DÄ°NLEYÄ°CÄ°LERÄ° !!!
    // =========================================================================
    
    // HaritayÄ± baÅŸlatan ana fonksiyon
    function initMap() {
        const southWest = L.latLng(35.8, 25.5); 
        const northEast = L.latLng(42.5, 44.8); 
        const bounds = L.latLngBounds(southWest, northEast);

        map = L.map('map', { 
            maxBounds: bounds, 
            minZoom: 6,      
            maxBoundsViscosity: 1.0 
        }).setView([39.0000, 35.0000], 6); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap katkÄ±cÄ±larÄ±'
        }).addTo(map);

        markers.addTo(map); // Marker grubunu haritaya ekle

        L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: "Konum Ara (Ã–rn: Ä°stanbul, BahÃ§elievler)",
            collapsed: false,
        })
        .on('markgeocode', function(e) {
            // Arama sonucunda haritayÄ± ilgili konuma odakla
            map.fitBounds(e.geocode.bbox);
            
            // Marker ekleme ve form oluÅŸturma iÅŸlemini burada da Ã§aÄŸÄ±rabilirsiniz (isteÄŸe baÄŸlÄ±)
            const { lat, lng } = e.geocode.center;
            
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            tempMarker = L.marker([lat, lng]).addTo(map);
            
            // Konum bilgileri genellikle geocode.name iÃ§inde bulunur.
            const il = e.geocode.name.split(',').pop().trim() || "Bilinmiyor"; 
            const ilce = e.geocode.name.split(',')[0].trim() || "Bilinmiyor"; 

            document.getElementById('infoBox').innerHTML = getFormHTML(lat.toFixed(5), lng.toFixed(5), il, ilce);
            restrictDateInput();
        })
        .addTo(map);

        // Harita TÄ±klama Olay Dinleyicisi - KRÄ°TÄ°K DÃœZELTME BURADA
        map.on('click', async function(e) {
            const { lat, lng } = e.latlng;
            
            // GeÃ§ici iÅŸaretÃ§iyi kaldÄ±r
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            
            // Yeni geÃ§ici iÅŸaretÃ§i ekle
            tempMarker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], 12); // Konuma yakÄ±nlaÅŸ

            // Konum bilgilerini ters coÄŸrafi kodlama ile al
            const { il, ilce } = await getLocationFromCoords(lat, lng);

            // Bilgi kutusuna formu yerleÅŸtir
            document.getElementById('infoBox').innerHTML = getFormHTML(lat.toFixed(5), lng.toFixed(5), il, ilce);
            
            // Tarih alanÄ±nÄ± kÄ±sÄ±tla
            restrictDateInput();
        });
    }

    // Sayfa yÃ¼klendiÄŸinde haritayÄ± baÅŸlat ve diÄŸer iÅŸlemleri yap - KRÄ°TÄ°K DÃœZELTME BURADA
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        restrictDateInput(); // Ä°lk yÃ¼klemede de kÄ±sÄ±tla
        updateKesintiListesi(); // VarsayÄ±lan boÅŸ listeyi gÃ¶ster
        updateIspLeaderboard();
        updateLocationLeaderboard();
        updateMonthlyIspLeaderboard();
    });
</script>
</body>
</html>

