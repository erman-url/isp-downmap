<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISP Kesinti Bildirim HaritasÄ± (TÃ¼rkiye)</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <style>
        /* CSS Stilleri (DeÄŸiÅŸiklik yapÄ±lmamÄ±ÅŸtÄ±r) */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --text-color: #212529;
            --border-radius: 8px;
            --padding-base: 15px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--padding-base);
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: var(--padding-base) 0;
            text-align: center;
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            font-size: 2em;
        }

        #map {
            height: 500px; 
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .content-section {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .flex-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap; 
        }

        .flex-item {
            flex: 1;
            min-width: 300px; 
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box; 
        }

        .btn-submit {
            background-color: var(--success-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        .btn-submit:hover:not(:disabled) {
            background-color: #218838;
        }

        .btn-submit:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }

        .leaderboard-title {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .isp-name {
            font-weight: bold;
        }

        .count {
            color: var(--danger-color);
            font-weight: bold;
        }

        .alert-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #data-status {
            font-size: 0.9em;
            color: var(--secondary-color);
            margin-top: 5px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em; 
            }

            #map {
                height: 300px; 
            }

            .flex-container {
                flex-direction: column; 
                gap: 15px;
            }

            .flex-item {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>ISP Kesinti Bildirim HaritasÄ±</h1>
    </div>

    <div class="container">
        
        <div class="content-section">
            <p>Haritada bir konum seÃ§in veya arama yapÄ±n. Kesintinin tam konumunu iÅŸaretlemek iÃ§in haritaya **tÄ±klayÄ±n**.</p>
            <div id="map"></div>
            <div id="selected-location" style="margin-top: 10px; font-weight: bold;">
                SeÃ§ilen Konum: Belirtilmedi
            </div>
            <div id="data-status">GerÃ§ek zamanlÄ± veriler yÃ¼kleniyor...</div>
        </div>

        <hr> 

        <div class="flex-container">
            
            <div class="flex-item content-section">
                <h2>Kesinti Bildirimi Yap</h2>
                <form id="kesinti-form">
                    <div class="form-group">
                        <label for="isp">Ä°nternet Servis SaÄŸlayÄ±cÄ± (ISS):</label>
                        <select id="isp" required>
                            <option value="">SeÃ§iniz</option>
                            <option value="Turkcell Superonline">Turkcell Superonline</option>
                            <option value="Turk Telekom">TÃ¼rk Telekom</option>
                            <option value="Vodafone Net">Vodafone Net</option>
                             <option value="Vodafone Net">DigiTurk Net</option>
                            <option value="Turksat KabloNet">Turksat KabloNet</option>
                            <option value="Millenicom">Millenicom</option>
                            <option value="Turknet">TÃ¼rknet</option>
                            <option value="DiÄŸer">DiÄŸer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="il">Ä°l (Otomatik Dolacak):</label>
                        <input type="text" id="il" readonly required>
                    </div>

                    <div class="form-group">
                        <label for="ilce">Ä°lÃ§e (Otomatik Dolacak):</label>
                        <input type="text" id="ilce" readonly required>
                    </div>
                    
                    <div class="form-group">
                        <label for="kesintiTarihi">Kesinti BaÅŸlangÄ±Ã§ Tarihi ve Saati:</label>
                        <input type="datetime-local" id="kesintiTarihi" required>
                    </div>

                    <div class="form-group">
                        <label for="tahminiBitisSaati">Tahmini BitiÅŸ Saati (Opsiyonel):</label>
                        <input type="time" id="tahminiBitisSaati">
                    </div>

                    <div class="form-group">
                        <label for="aciklama">Ek AÃ§Ä±klama (Kesinti Nedeni vb.):</label>
                        <textarea id="aciklama" rows="3" maxlength="200" placeholder="Maksimum 200 karakter."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="captcha">Robot OlmadÄ±ÄŸÄ±nÄ±zÄ± OnaylayÄ±n (5 + 3 = ?):</label>
                        <input type="number" id="captcha" required>
                    </div>

                    <div id="form-message" class="alert-message" style="display: none;"></div>

                    <button type="submit" class="btn-submit">Bildirimi GÃ¶nder</button>
                </form>
            </div>

            <div class="flex-item content-section">
                <h2>ðŸ“¢ GerÃ§ek ZamanlÄ± Kesinti Bildirimleri</h2>
                <p>KullanÄ±cÄ±lar tarafÄ±ndan harita Ã¼zerinden bildirilen son veriler aÅŸaÄŸÄ±dadÄ±r. (Google E-Tablo'dan canlÄ± Ã§ekilmiÅŸtir.)</p>
                
                <div id="real-time-data" style="margin-top: 20px;">
                    <iframe 
                        src="https://docs.google.com/spreadsheets/d/e/2PACX-1vS0Jvaf_CyFyWoYxeG49QZCM-jaSk4SM_FzIf3XA2bR1D0-mT6XDyz-D2vEn4Lqm1MFZ1UtCcULauYX/pubhtml?gid=800815817&amp;single=true&amp;widget=true&amp;headers=false" 
                        width="100%" 
                        height="400" 
                        frameborder="0"
                    ></iframe>
                </div>
                <hr>

                <h2>ISS Kesinti Liderlik Tablosu</h2>
                <p>TÃ¼rkiye genelindeki son 24 saat kesinti bildirim sayÄ±larÄ± (SimÃ¼lasyon).</p>
                
                <div id="leaderboard">
                    <h3 class="leaderboard-title">En Ã‡ok Bildirim Alan ISP'ler</h3>
                    
                    <div class="leaderboard-item">
                        <span class="isp-name">TÃ¼rk Telekom</span>
                        <span class="count">45 Bildirim</span>
                    </div>
                    <div class="leaderboard-item">
                        <span class="isp-name">Turkcell Superonline</span>
                        <span class="count">28 Bildirim</span>
                    </div>
                    <div class="leaderboard-item">
                        <span class="isp-name">TÃ¼rknet</span>
                        <span class="count">15 Bildirim</span>
                    </div>
                    <div class="leaderboard-item">
                        <span class="isp-name">Vodafone Net</span>
                        <span class="count">12 Bildirim</span>
                    </div>
                    <div class="leaderboard-item">
                        <span class="isp-name">Millenicom</span>
                        <span class="count">5 Bildirim</span>
                    </div>
                    <div class="leaderboard-item">
                        <span class="isp-name">Turksat KabloNet</span>
                        <span class="count">4 Bildirim</span>
                    </div>
                </div>

                <hr>

                <h2>Genel Ä°statistikler</h2>
                <p>TÃ¼m zamanlarÄ±n toplam bildirim sayÄ±sÄ±:</p>
                <div style="font-size: 2em; font-weight: bold; color: var(--primary-color);">12.540</div>
                <p>Åžu an aktif olduÄŸu dÃ¼ÅŸÃ¼nÃ¼len kesinti sayÄ±sÄ±:</p>
                <div style="font-size: 2em; font-weight: bold; color: var(--danger-color);">98</div>
            </div>
        </div>

    </div>

   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    // ===================================================================
    // GOOGLE FORM VE TABLO ID'LERÄ°
    // ===================================================================
    const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLScegs6ds3HEEFHMm-IMI9aEnK3-Otz-LKpqKYnmyWQ9B7zquQ/formResponse';
    
    // Bu deÄŸerleri Google Form'unuza baÄŸlÄ± E-Tablo URL'nizden almalÄ±sÄ±nÄ±z!
    const SPREADSHEET_ID = '1FAIpQLScegs6ds3HEEFHMm-IMI9aEnK3-Otz-LKpqKYnmyWQ9B7zquQ'; // Form URL'indeki ID (1FAIpQLS...quQ)
    const SHEET_GID = '800815817'; // E-Tablo'nun ilk sekmesinin GID'si

    // Google Query API URL'si
    // NOT: Bu URL, tÃ¼m tablonun JSON olarak Ã§ekilmesini saÄŸlar.
    const DATA_SOURCE_URL = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_ID}/pubg?output=json&gid=${SHEET_GID}`;


    const FORM_ENTRY_IDS = {
        isp: 'entry.1321343715',
        il: 'entry.1048550212',
        ilce: 'entry.1808925592',
        enlem: 'entry.119292663',
        boylam: 'entry.1923451466',
        aciklama: 'entry.1702812039',
        
        kesintiTarihi_year: 'entry.888686904_year',
        kesintiTarihi_month: 'entry.888686904_month',
        kesintiTarihi_day: 'entry.888686904_day',
        
        baslangicSaati_hour: 'entry.1555945811_hour',
        baslangicSaati_minute: 'entry.1555945811_minute',

        tahminiBitisSaati_hour: 'entry.126525220_hour',
        tahminiBitisSaati_minute: 'entry.126525220_minute'
    };
    // ===================================================================

    let map;
    let marker; 
    let realtimeMarkers = L.layerGroup(); 
    let selectedCoords; 

    const TURKEY_CENTER = [39.9334, 32.8597]; 
    const TURKEY_BOUNDS = [
        [35.8154, 25.567], 
        [42.100, 44.811] 
    ];

    function initMap() {
        map = L.map('map', {
            center: TURKEY_CENTER,
            zoom: 6,
            minZoom: 6, 
            maxBounds: TURKEY_BOUNDS, 
            maxBoundsViscosity: 1.0
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        L.Control.geocoder({
            placeholder: "Adres, Ä°l veya Ä°lÃ§e ara...",
            defaultMarkGeocode: false,
            collapsed: L.Browser.mobile,
            geocoder: L.Control.Geocoder.nominatim({
                serviceUrl: 'https://nominatim.openstreetmap.org/search',
                countrycodes: 'tr' 
            })
        }).on('markgeocode', function(e) {
            const center = e.geocode.center;
            map.setView(center, 13);
            updateMarkerAndFields(center.lat, center.lng);
        }).addTo(map);

        map.on('click', onMapClick);
        
        realtimeMarkers.addTo(map);

        fetchRealTimeMarkers(); 
    }

    // ===================================================================
    // YENÄ° VERÄ° Ä°ÅžLEME VE GÃœNCELLEME FONKSÄ°YONLARI
    // ===================================================================

    /**
     * Google E-Tablo verilerini iÅŸler ve bir obje dizisi dÃ¶ndÃ¼rÃ¼r.
     * @param {Object} data - Google Sheets JSON'dan parse edilmiÅŸ veri objesi.
     * @returns {Array} Ä°ÅŸlenmiÅŸ veri objeleri dizisi.
     */
    function processSheetData(data) {
        const processedData = [];
        
        // Ä°lk satÄ±r baÅŸlÄ±k olduÄŸu iÃ§in 'rows[0]' baÅŸlÄ±klarÄ± iÃ§erir, bu yÃ¼zden 'i=1'den baÅŸlÄ±yoruz
        for (let i = 1; i < data.rows.length; i++) {
            const row = data.rows[i].c;
            
            // A SÃ¼tunu (Zaman DamgasÄ±)
            let timestamp = null;
            if (row[0] && row[0].v) {
                const dateString = row[0].v.replace('Date(', '').replace(')', '');
                const [year, month, day, hour, minute, second] = dateString.split(',').map(Number);
                // NOT: Google'da ay 0-11 arasÄ±dÄ±r.
                timestamp = new Date(year, month, day, hour, minute, second).getTime();
            }

            // G SÃ¼tunu (Tahmini BitiÅŸ Saati - Kesintinin aktif olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in)
            // Tahmini bitiÅŸ saati (saat ve dakika) olarak formda ayrÄ± ayrÄ± tutulduÄŸu iÃ§in bu alan boÅŸ gelebilir. 
            // Bu alana ihtiyacÄ±mÄ±z yok, ancak Google Form'un kaydettiÄŸi tÃ¼m sÃ¼tunlara eriÅŸebiliriz. 
            // Aktif/Pasif durumu basitÃ§e son 24 saat iÃ§inde bildirilip bildirilmediÄŸine gÃ¶re belirleyelim.
            
            processedData.push({
                timestamp: timestamp,
                isp: row[1] ? row[1].v : 'Bilinmiyor', // B SÃ¼tunu: ISS
                il: row[2] ? row[2].v : 'Bilinmiyor',   // C SÃ¼tunu: Ä°l
                ilce: row[3] ? row[3].v : 'Bilinmiyor', // D SÃ¼tunu: Ä°lÃ§e
                enlem: row[4] ? Number(row[4].v) : null, // E SÃ¼tunu: Enlem
                boylam: row[5] ? Number(row[5].v) : null // F SÃ¼tunu: Boylam
            });
        }
        return processedData;
    }

    /**
     * Son 24 saatteki verileri filtreler.
     * @param {Array} allData - processSheetData'dan gelen tÃ¼m veriler.
     * @returns {Array} Son 24 saatteki veriler.
     */
    function filterLast24Hours(allData) {
        const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
        return allData.filter(item => item.timestamp >= twentyFourHoursAgo);
    }
    
    /**
     * GerÃ§ek zamanlÄ± verileri Ã§eker, haritayÄ± gÃ¼nceller ve istatistikleri hesaplar.
     */
    function fetchRealTimeMarkers() {
        document.getElementById('data-status').textContent = 'GerÃ§ek zamanlÄ± veriler yÃ¼kleniyor...';
        
        fetch(DATA_SOURCE_URL)
            .then(response => response.text())
            .then(dataText => {
                // Google Sheets'ten gelen JSON text'ini temizleyip parse ediyoruz
                // Google'dan gelen JSON'un baÅŸÄ±nda "google.visualization.Query.setResponse(" kÄ±smÄ± var.
                const jsonString = dataText.substring(47).slice(0, -2);
                const data = JSON.parse(jsonString);

                const allData = processSheetData(data.table);
                const last24HoursData = filterLast24Hours(allData);

                // 1. Harita MarkerlarÄ±nÄ± GÃ¼ncelle
                updateMapMarkers(last24HoursData);

                // 2. Liderlik Tablosunu GÃ¼ncelle
                updateLeaderboard(last24HoursData);

                // 3. Genel Ä°statistikleri GÃ¼ncelle
                updateGeneralStatistics(allData.length, last24HoursData.length);
                
                document.getElementById('data-status').textContent = `Son 24 saatte ${last24HoursData.length} adet kesinti bildirimi haritada gÃ¶sterildi.`;
            })
            .catch(error => {
                console.error('GerÃ§ek zamanlÄ± veri Ã§ekme hatasÄ±:', error);
                document.getElementById('data-status').textContent = 'âš ï¸ GerÃ§ek zamanlÄ± veriler yÃ¼klenirken bir hata oluÅŸtu.';
                updateGeneralStatistics(0, 0); // Hata durumunda istatistikleri sÄ±fÄ±rla
            });
    }

    /**
     * Harita Ã¼zerindeki markerlarÄ± gÃ¼nceller.
     * @param {Array} filteredData - Son 24 saatteki kesinti verileri.
     */
    function updateMapMarkers(filteredData) {
        realtimeMarkers.clearLayers(); 
        
        let markerCount = 0;
        
        filteredData.forEach(item => {
            if (item.enlem && item.boylam) {
                
                const date = new Date(item.timestamp);
                const formattedDate = `${date.toLocaleDateString('tr-TR')} ${date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                
                const popupContent = `
                    <strong>ISS:</strong> ${item.isp}<br>
                    <strong>Konum:</strong> ${item.ilce} / ${item.il}<br>
                    <strong>Bildirim Tarihi:</strong> ${formattedDate}
                `;

                L.marker([item.enlem, item.boylam])
                    .bindPopup(popupContent)
                    .addTo(realtimeMarkers);
                    
                markerCount++;
            }
        });

        if (markerCount > 0) {
            map.fitBounds(realtimeMarkers.getBounds());
        } else {
            map.setView(TURKEY_CENTER, 6);
        }
    }


    /**
     * ISS Kesinti Liderlik Tablosunu gÃ¼nceller.
     * @param {Array} last24HoursData - Son 24 saatteki kesinti verileri.
     */
    function updateLeaderboard(last24HoursData) {
        const leaderboardDiv = document.getElementById('leaderboard');
        const ispCounts = {};

        // ISS'lere gÃ¶re bildirim sayÄ±sÄ±nÄ± hesapla
        last24HoursData.forEach(item => {
            const ispName = item.isp || 'Bilinmiyor';
            ispCounts[ispName] = (ispCounts[ispName] || 0) + 1;
        });

        // Objeyi [ISS AdÄ±, SayÄ±] dizisine dÃ¶nÃ¼ÅŸtÃ¼r ve sayÄ±ya gÃ¶re sÄ±rala (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
        const sortedIspCounts = Object.entries(ispCounts)
            .sort(([, countA], [, countB]) => countB - countA);

        // HTML iÃ§eriÄŸini oluÅŸtur
        let leaderboardHTML = `<h3 class="leaderboard-title">En Ã‡ok Bildirim Alan ISP'ler (Son 24 Saat)</h3>`;

        if (sortedIspCounts.length === 0) {
            leaderboardHTML += `<p>Son 24 saat iÃ§inde bildirim yapÄ±lmamÄ±ÅŸtÄ±r.</p>`;
        } else {
            // Ä°lk 5 veya 10 sonucu gÃ¶sterilebilir. Åžu an tÃ¼mÃ¼nÃ¼ gÃ¶sterelim.
            sortedIspCounts.forEach(([isp, count]) => {
                leaderboardHTML += `
                    <div class="leaderboard-item">
                        <span class="isp-name">${isp}</span>
                        <span class="count">${count} Bildirim</span>
                    </div>
                `;
            });
        }
        
        leaderboardDiv.innerHTML = leaderboardHTML;
    }

    /**
     * Genel Ä°statistikler bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¼nceller.
     * @param {number} totalCount - TÃ¼m zamanlarÄ±n toplam bildirim sayÄ±sÄ±.
     * @param {number} activeCount - Son 24 saatteki (Aktif olduÄŸu varsayÄ±lan) bildirim sayÄ±sÄ±.
     */
    function updateGeneralStatistics(totalCount, activeCount) {
        // Toplam Bildirim SayÄ±sÄ±
        const totalDiv = document.querySelector('.flex-item:nth-child(2) > div:nth-child(8)');
        if (totalDiv) {
             // totalDiv.nextElementSibling Toplam bildirim sayÄ±sÄ± deÄŸerini tutan div olmalÄ±
             totalDiv.nextElementSibling.innerHTML = totalCount.toLocaleString('tr-TR');
        }

        // Aktif Kesinti SayÄ±sÄ±
        const activeDiv = document.querySelector('.flex-item:nth-child(2) > div:nth-child(10)');
        if (activeDiv) {
            // activeDiv.nextElementSibling Aktif kesinti sayÄ±sÄ± deÄŸerini tutan div olmalÄ±
            activeDiv.nextElementSibling.innerHTML = activeCount.toLocaleString('tr-TR');
        }
    }


    // ===================================================================
    // MEVCUT FORM Ä°ÅžLEME FONKSÄ°YONLARI (DeÄŸiÅŸken ismi hatasÄ± dÃ¼zeltilmiÅŸ ve sanitasyon eklenmiÅŸ hali)
    // ===================================================================
    
    function onMapClick(e) {
        updateMarkerAndFields(e.latlng.lat, e.latlng.lng);
    }

    function updateMarkerAndFields(lat, lng) {
        selectedCoords = { lat, lng };

        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map)
                .bindPopup("Kesinti Konumu").openPopup();
        }

        document.getElementById('selected-location').innerText = `SeÃ§ilen Konum: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        getLocationFromCoords(lat, lng);
    }

    function getLocationFromCoords(lat, lng) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const address = data.address;
                
                let il = address.state || address.province || "Bilinmiyor";
                let ilce = address.county || address.state_district || address.city_district || "Bilinmiyor";

                if (ilce === "Bilinmiyor") {
                    ilce = address.city || address.town || address.village || "Bilinmiyor";
                }

                if (ilce === il && ilce !== "Bilinmiyor") {
                    ilce = "Merkez Ä°lÃ§e"; 
                }

                document.getElementById('il').value = il;
                document.getElementById('ilce').value = ilce;
            })
            .catch(error => {
                console.error('CoÄŸrafi kodlama hatasÄ±:', error);
                document.getElementById('il').value = 'Hata';
                document.getElementById('ilce').value = 'Hata';
            });
    }
    
    // GÃ¼venlik iyileÅŸtirmesi iÃ§in temel sanitasyon fonksiyonu
    function sanitizeInput(text) {
        if (typeof text !== 'string') return text;
        return text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function sendDataToGoogleForm(data) {
        const form = document.getElementById('kesinti-form');
        const messageDiv = document.getElementById('form-message');
        const submitBtn = document.querySelector('.btn-submit');
        messageDiv.style.display = 'none';

        if (!selectedCoords) {
            showMessage('LÃ¼tfen haritada kesinti konumunu iÅŸaretleyin.', 'danger');
            return;
        }

        submitBtn.disabled = true; 
        submitBtn.textContent = 'GÃ¶nderiliyor...';


        const kesintiDate = new Date(data.kesintiTarihiRaw);
        
        const baslangicSaati_hour = kesintiDate.getHours().toString().padStart(2, '0');
        const baslangicSaati_minute = kesintiDate.getMinutes().toString().padStart(2, '0');
        const tahminiBitisSaati = data.tahminiBitisSaati;

        const sanitizedAciklama = sanitizeInput(data.aciklama);

        const formData = new URLSearchParams();
        formData.append(FORM_ENTRY_IDS.isp, data.isp);
        formData.append(FORM_ENTRY_IDS.il, data.il);
        formData.append(FORM_ENTRY_IDS.ilce, data.ilce);
        formData.append(FORM_ENTRY_IDS.enlem, data.enlem);
        formData.append(FORM_ENTRY_IDS.boylam, data.boylam);
        formData.append(FORM_ENTRY_IDS.aciklama, sanitizedAciklama); 

        formData.append(FORM_ENTRY_IDS.kesintiTarihi_year, kesintiDate.getFullYear());
        formData.append(FORM_ENTRY_IDS.kesintiTarihi_month, kesintiDate.getMonth() + 1); 
        formData.append(FORM_ENTRY_IDS.kesintiTarihi_day, kesintiDate.getDate());

        formData.append(FORM_ENTRY_IDS.baslangicSaati_hour, baslangicSaati_hour);
        formData.append(FORM_ENTRY_IDS.baslangicSaati_minute, baslangicSaati_minute);
        
        if (tahminiBitisSaati) {
            formData.append(FORM_ENTRY_IDS.tahminiBitisSaati_hour, tahminiBitisSaati.split(':')[0]);
            formData.append(FORM_ENTRY_IDS.tahminiBitisSaati_minute, tahminiBitisSaati.split(':')[1]);
        }
        
        fetch(GOOGLE_FORM_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: formData
        })
        .then(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Bildirimi GÃ¶nder';

            showMessage('Bildirim baÅŸarÄ±yla gÃ¶nderildi! TeÅŸekkÃ¼r ederiz.', 'success');
            form.reset();
            
            if(marker) {
                map.removeLayer(marker);
                marker = null;
            }
            selectedCoords = null;
            document.getElementById('selected-location').innerText = 'SeÃ§ilen Konum: Belirtilmedi';

            fetchRealTimeMarkers(); 
        })
        .catch(error => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Bildirimi GÃ¶nder';
            
            console.error('GÃ¶nderim sÄ±rasÄ±nda hata oluÅŸtu.', error);
            showMessage('Bildirim gÃ¶nderilirken bir sorun oluÅŸtu. LÃ¼tfen tekrar deneyin.', 'danger');
        });
    }

    function showMessage(message, type) {
        const messageDiv = document.getElementById('form-message');
        messageDiv.textContent = message;
        messageDiv.className = `alert-message alert-${type}`;
        messageDiv.style.display = 'block';
    }

    document.getElementById('kesinti-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const isp = document.getElementById('isp').value;
        const il = document.getElementById('il').value;
        const ilce = document.getElementById('ilce').value;
        const kesintiTarihiRaw = document.getElementById('kesintiTarihi').value;
        const tahminiBitisSaati = document.getElementById('tahminiBitisSaati').value;
        const aciklama = document.getElementById('aciklama').value;
        const captchaInput = parseInt(document.getElementById('captcha').value);

        // 1. CAPTCHA KontrolÃ¼ (5 + 3 = 8)
        if (captchaInput !== 8) {
            showMessage('CAPTCHA cevabÄ± yanlÄ±ÅŸ! LÃ¼tfen tekrar deneyin.', 'danger');
            return;
        }

        // 2. Harita Konum KontrolÃ¼
        if (!selectedCoords || il === 'Bilinmiyor' || il === 'Hata') {
            showMessage('LÃ¼tfen haritada geÃ§erli bir konum seÃ§in ve Ä°l/Ä°lÃ§e bilgisinin dolmasÄ±nÄ± bekleyin.', 'danger');
            return;
        }

        // 3. Tarih KontrolÃ¼
        const now = new Date();
        const selectedDate = new Date(kesintiTarihiRaw);

        if (selectedDate > now) {
             showMessage('Kesinti baÅŸlangÄ±Ã§ tarihi ve saati gelecek bir zaman olamaz.', 'danger');
             return;
        }

        const data = {
            isp: isp,
            il: il,
            ilce: ilce,
            enlem: selectedCoords.lat,
            boylam: selectedCoords.lng,
            aciklama: aciklama,
            kesintiTarihiRaw: kesintiTarihiRaw,
            tahminiBitisSaati: tahminiBitisSaati
        };

        sendDataToGoogleForm(data);
    });

    document.addEventListener('DOMContentLoaded', initMap);

</script>
</body>
</html>
